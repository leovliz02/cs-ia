<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All Demands – Team Manager</title>
  {% load static%}
  <link rel="stylesheet" href="{% static 'styles.css' %}">
  <style>
    .container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .filter-section {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: #e9ecef;
        border-radius: 8px;
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;  
    }

    .filter-section label {
        font-weight: bold;
        margin-right: 0.5rem;
    }

    .filter-section select {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        min-width: 150px;
    }

    .filter-btn {
        padding: 0.5rem 1rem;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .filter-btn:hover {
        background-color: #0056b3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      padding: 0.75rem;
      border: 1px solid #ccc;
      text-align: left;
    }

    th {
      background-color: #f1f1f1;
    }

    .actions button {
      margin-right: 0.5rem;
      padding: 0.3rem 0.6rem;
      font-size: 0.9rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .edit-btn {
      background-color: #ffc107;
      color: white;
    }
    .edit-btn:hover { background-color: #e0a800; }

    .delete-btn {
      background-color: #dc3545;
      color: white;
    }
    .delete-btn:hover { background-color: #c82333; }

    .add-btn {
      padding: 0.5rem 1rem;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .add-btn:hover { background-color: #218838; }

    .assign-btn {
        background-color: #17a2b8;
        color: white;
    }
    .assign-btn:hover { background-color: #138496; }

    .popup-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      display: none;  
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .popup {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      width: 500px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      max-height: 90vh; 
      overflow-y: auto; 
    }

    .popup h3 {
      margin-top: 0;
    }

    .popup label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }

    .popup input,
    .popup select {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box; 
    }

    .popup-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 1.5rem;
    }

    .popup-buttons button {
      flex: 1;
      margin: 0 0.25rem;
      padding: 0.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .popup-buttons .cancel {
      background-color: #ccc;
    }
    .popup-buttons .cancel:hover { background-color: #b0b0b0; }

    .popup-buttons .save {
      background-color: #007bff;
      color: white;
    }
    .popup-buttons .save:hover { background-color: #0056b3; }

    .error-message {
        color: red;
        font-size: 0.85rem;
        margin-top: 0.5rem;
    }
  </style>
</head>
<body>

  <header>
    <h1>Manager Portal</h1>
    <a href="{% url 'logout' %}" class="logout-link">Logout</a>
  </header>

  <nav>
    <a href="{% url 'manager_teams_page' %}">Teams</a>
    <a href="{% url 'manager_demands_page' %}" class="active">Demands</a>
    <a href="{% url 'manager_approvals_page' %}">Approvals Pending</a>
  </nav>

  <div class="container">
    <h2>
      All Demands
      <button class="add-btn" onclick="openDemandPopup()">+ Add Demand</button>
    </h2>

    <!--filter options code-->
    <div class="filter-section">
        <form method="GET" class="filter-form">
            <label for="team_filter">Filter by Team:</label>
            <select name="team_id" id="team_filter">
                <option value="">All Teams</option>
                {% for team in teams %}
                    <option value="{{ team.teamID }}" {% if team.teamID|stringformat:"s" == selected_team_id %}selected{% endif %}>{{ team.teamName }}</option>
                {% endfor %}
            </select>

            <label for="assignment_filter">Filter by Assignment Status:</label>
            <select name="assignment_status" id="assignment_filter">
                <option value="">All</option>
                <option value="assigned" {% if selected_assignment_status == "assigned" %}selected{% endif %}>Assigned</option>
                <option value="unassigned" {% if selected_assignment_status == "unassigned" %}selected{% endif %}>Unassigned</option>
            </select>
            <button type="submit" class="filter-btn">Apply Filters</button>
        </form>
    </div>

    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Team</th>
          <th>Start Date</th>
          <th>Predicted End</th>
          <th>Actual End</th>
          <th>Time Required</th>
          <th>Completion Status</th>
          <th>Assignment Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="demandTableBody">
        {% for demand in demands %}
        <tr data-demand-id="{{ demand.demandID }}">
          <td>{{ demand.demand_name }}</td>
          <td>{% if demand.team %}{{ demand.team.team_name }}{% else %}Unassigned{% endif %}</td>
          <td>{{ demand.start_date|date:"d/m/y" }}</td>
          <td>{% if demand.estimated_end_date %}{{ demand.estimated_end_date|date:"d/m/y" }}{% else %}N/A{% endif %}</td>
          <td>{% if demand.actual_end_date %}{{ demand.actual_end_date|date:"d/m/y" }}{% else %}–{% endif %}</td>
          <td>{{ demand.timeNeeded }} hrs</td>
          <td>
            {% if demand.demand_completion_status == "finished" %}Finished{% else %}
                {% if demand.demand_completion_status == "in_progress" %}In Progress{% else %}
                    Pending
                {% endif %}
            {% endif %}
          </td>
          <td>{% if demand.team %}Assigned{% else %}Unassigned{% endif %}</td>
          <td class="actions">
            <button class="edit-btn" onclick="openDemandPopup('{{ demand.demandID }}')">Edit</button>
            {% if not demand.team %} {# Show assign button only if unassigned #}
                <button class="assign-btn" onclick="openDemandPopup('{{ demand.demandID }}')">Assign</button>
            {% endif %}
            <button class="delete-btn" onclick="deleteDemand('{{ demand.demandID }}')">Delete</button>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="9">No demands found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- popup to assign and edit demands -->
  <div class="popup-bg" id="demandPopupBg">
    <div class="popup">
      <h3 id="demandPopupTitle">Add Demand</h3>
      <form id="demandForm">
        {% csrf_token %}
        <input type="hidden" id="demandId" name="demandID" />

        <label for="demandName">Demand Name:</label>
        <input type="text" id="demandName" name="demandName" required />

        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate" name="startDate" required />

        <label for="timeRequired">Time Required (hours):</label>
        <input type="number" id="timeRequired" name="timeRequired" min="1" required />

        <label for="allocationModeSelection">Allocation Mode:</label>
        <select id="allocationModeSelection" name="allocationModeSelection">
            <option value ="NA"> -- Select Allocation Mode -- </option>
            <option value="Regular">Evenly Distributed (Can take time)</option>
            <option value="Urgent">Squeezed (Urgent)</option>
        </select>

        <div id="assignTeamContainer" style="display: none;">
          <label for="demandTeam">Assign Team:</label>
          <select id="demandTeam" name="team_id">
            <option value="">-- Select Team --</option>
            {% for team in teams %}
                <option value="{{ team.teamID }}">{{ team.team_name }}</option>
            {% endfor %}
          </select>
        </div>

        <div id="predictedEndDateGroup" style="display: none;">
          <label for="predictedEndInput">Predicted End Date (for urgent requests):</label>
          <input type="date" id="predictedEndInput" name="predicted_end" />
        </div>

        <label for="status">Completion Status:</label>
        <select id="status" name="status">
          <option value="pending">Pending</option>
          <option value="in_progress">In Progress</option>
          <option value="finished">Finished</option>
        </select>

        <label for="actualEndReadonly">Actual End Date:</label>
        <input type="date" id="actualEndReadonly" readonly />

        <div id="formErrorMessage" class="error-message"></div>

        <div class="popup-buttons">
          <button type="button" class="cancel" onclick="closeDemandPopup()">Cancel</button>
          <button type="submit" class="save">Save Demand</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentDemandId = null; // keeps track of which demand is being edited/assigned

    // cookie management for crsf token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // choose allocation to show the edit function for predicted end date if even is clicked, and if its urgent/squeezed mode, its hidden.
  function togglePredictedEndDateVisibility() {
      const predictedEndGroup = document.getElementById("predictedEndDateGroup");
      const assignTeamContainer = document.getElementById("assignTeamContainer");

      if (allocationModeSelection.value === "NA") {
          predictedEndGroup.style.display = "none";
          assignTeamContainer.style.display = "none";
      }

      if (allocationModeSelection.value === "even") {
          assignTeamContainer.style.display = "block";
      } else if (allocationModeSelection.value === "squeeze") {
          predictedEndGroup.style.display = "block";
      }
  }



//edit/asisgn demand view
async function openDemandPopup(demandId = null) {
    //if (demandForm) demandForm.reset();
        if (formErrorMessage) formErrorMessage.textContent = '';
        currentDemandId = demandId;
        if (predictedEndInput) predictedEndInput.value = '';

        if (demandId) {
            if (demandPopupTitle) demandPopupTitle.innerText = "Edit Demand";

            //if (allocationModeSelection.value !== "NA"){
              try {
                  const MANAGE_DEMAND_BASE_URL = "{% url 'manage_demand_api' 0 %}".replace('0/', '');
                  const response = await fetch(`${MANAGE_DEMAND_BASE_URL}${demandId}/`);
                  if (!response.ok) throw new Error('Failed to fetch demand data.');

                  const demandData = await response.json();
                  console.log('demandData',demandData)
                  if (demandNameInput) demandNameInput.value = demandData.demand_name;
                  if (startDateInput) startDateInput.value = demandData.start_date;
                  if (timeRequiredInput) timeRequiredInput.value = demandData.time_needed;
                  if (demandTeamSelect) demandTeamSelect.value = demandData.team_id || '';
                  if (allocationModeSelection) allocationModeSelection.value = demandData.allocation_mode || 'NA'; 
                  togglePredictedEndDateVisibility();
                  if (predictedEndInput) predictedEndInput.value = demandData.predicted_end_date || ''; 
                  if (actualEndReadonly) actualEndReadonly.value = demandData.actual_end_date || ''; 
                  if (statusSelect) statusSelect.value = demandData.demand_completion_status || 'pending';

                  if (startDateInput) startDateInput.disabled = true;
                  if (timeRequiredInput) timeRequiredInput.disabled = true;
              } catch (error) {
                  console.error("Error in openDemandPopup fetch:", error); 
                  if (formErrorMessage) formErrorMessage.textContent = `Could not load demand details.`;
                  if (demandPopupBg) demandPopupBg.style.display = 'none';
                  return;
              }
            //}
        } else {
            if (demandPopupTitle) demandPopupTitle.innerText = "Add Demand";
            if (allocationModeSelection) allocationModeSelection.value = 'NA';
            if (startDateInput) startDateInput.disabled = false;
            if (timeRequiredInput) timeRequiredInput.disabled = false;
            togglePredictedEndDateVisibility();
        }

        togglePredictedEndDateVisibility();
        if (demandPopupBg) demandPopupBg.style.display = 'flex';
    }



    function closeDemandPopup() {
      demandPopupBg.style.display = 'none';
      demandForm.reset();
      formErrorMessage.textContent = '';
      currentDemandId = null;
    }

//to delete the demand
    async function deleteDemand(demandId) {
      if (!confirm("Are you sure you want to delete this demand?")) {
        return;
      }

      try {
        const DELETE_DEMAND_BASE_URL = "{% url 'delete_demand_api' 0 %}".replace('0/', '');
        const response = await fetch(`${DELETE_DEMAND_BASE_URL}${demandId}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
          },
        });

        const data = await response.json();

        if (response.ok) {
          alert(data.message || 'Demand deleted successfully!');
          location.reload(); 
        } else {
          alert('Error deleting demand: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Fetch error:', error);
        alert('An error occurred while communicating with the server.');
      }
    }


demandForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    formErrorMessage.textContent = '';

    const MANAGE_DEMAND_BASE_URL = "{% url 'manage_demand_api' 0 %}".replace('0/', '');
    const url = currentDemandId ? `${MANAGE_DEMAND_BASE_URL}${currentDemandId}/` : MANAGE_DEMAND_BASE_URL;
    const method = currentDemandId ? 'PUT' : 'POST';

    const formData = {
        demand_name: demandNameInput.value,
        start_date: startDateInput.value,
        time_needed: parseFloat(timeRequiredInput.value),
        team_id: demandTeamSelect.value || null,
        allocation_mode: allocationModeSelection.value,
        demand_completion_status: statusSelect.value,
    };

    if (allocationModeSelection.value === 'squeeze') {
        if (!predictedEndInput.value) {
            formErrorMessage.textContent = 'Predicted End Date is required for Urgent (Squeezed) mode.';
            return;
        }
        formData.predictedEnd = predictedEndInput.value;
    } else {
        formData.predictedEnd = null;
    }

    try {
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify(formData),
        });

        const data = await response.json();
        if (response.ok) {
            alert(data.message || 'Demand saved successfully!');
            location.reload();
        } else {
            formErrorMessage.textContent = data.error || 'Error saving demand: Unknown error';
        }
    } catch (error) {
        console.error('Fetch error:', error);
        formErrorMessage.textContent = 'An error occurred while communicating with the server.';
    }
    //const response = await fetch(url)
    //if (response.ok) {
        closeDemandPopup();
    //}
});

    document.addEventListener("DOMContentLoaded", async function () {

        demandPopupBg = document.getElementById('demandPopupBg'); 
        demandForm = document.getElementById('demandForm');
        demandPopupTitle = document.getElementById('demandPopupTitle');
        formErrorMessage = document.getElementById('formErrorMessage');


        demandNameInput = document.getElementById('demandName');
        startDateInput = document.getElementById('startDate');
        timeRequiredInput = document.getElementById('timeRequired');
        demandTeamSelect = document.getElementById('demandTeam');
        predictedEndDateGroup = document.getElementById('predictedEndDateGroup');
        predictedEndInput = document.getElementById('predictedEndInput');
        statusSelect = document.getElementById('status');
        actualEndReadonly = document.getElementById('actualEndReadonly');
        allocationModeSelection = document.getElementById("allocationModeSelection"); 

    if (allocationModeSelection) {
      allocationModeSelection.addEventListener("change", togglePredictedEndDateVisibility);
    }

    if (predictedEndInput) {
      predictedEndInput.addEventListener('change', async () => {
        if (allocationModeSelection.value !== 'squeeze' || !predictedEndInput.value) return;

        const url = '/api/get_teams_meeting_deadline/';
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({
                    predicted_end: predictedEndInput.value,
                    start_date: startDateInput.value,
                    time_required: parseFloat(timeRequiredInput.value)
                })
            });
            const data = await res.json();

            const label = document.querySelector("label[for='demandTeam']");
            label.textContent = "Available Teams (choose one):";  
            
            demandTeamSelect.innerHTML = '';
            if (data.length > 0) {
                data.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.team_id;
                    option.text = team.team_name;
                    demandTeamSelect.appendChild(option);
                });
            } else {
                alert('No teams available for selected deadline. Switching to team-first allocation.');
                allocationModeSelection.value = 'even';
                togglePredictedEndDateVisibility();
                const label = document.querySelector("label[for='demandTeam']");
                label.textContent = "Assign Team:";
            }
        } catch (err) {
            console.error('Error fetching available teams:', err);
            alert('Server error while checking team availability.');
        }
    });

    }
  });
  </script>

</body>
</html>