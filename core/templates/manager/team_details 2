<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manager Portal â€“ Teams</title>
  {% load static%}
  <link rel="stylesheet" href="{% static 'styles.css' %}">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
    }

    header {
      background: #007bff;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
        flex-grow: 1;
        text-align: center;
    }

    .logout-link {
        color: white;
        text-decoration: none;
        font-weight: bold;
        padding: 0.5rem 1rem;
        border: 1px solid white;
        border-radius: 5px;
        transition: background-color 0.3s ease;
    }

    .logout-link:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    nav {
      display: flex;
      background: #eee;
      border-bottom: 1px solid #ccc;
    }

    nav a {
      flex: 1;
      text-align: center;
      padding: 1rem;
      text-decoration: none;
      font-weight: bold;
      color: black;
      border-bottom: 3px solid transparent;
    }

    nav a.active {
      background: white;
      border-bottom: 3px solid #007bff;
      color: #007bff;
    }
    
    nav a:hover {
      background-color: #e1dfdf;
    }

    .container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 1rem;
      background: white; 
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
    }

    .top-bar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 1rem;
    }

    .top-bar button {
      background-color: #007bff;
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .top-bar button:hover {
        background-color: #0056b3;
    }

    .team-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .team-box {
      flex: 1 1 250px;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
      font-size: 1.5rem;
      transition: transform 0.2s ease;
      cursor: pointer;
    }

    .team-box:hover {
      transform: scale(1.02);
    }

  
    .popup-bg {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .popup {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      max-height: 90vh; 
      overflow-y: auto;
    }

    .popup h3 {
      margin-top: 0;
    }

    .popup label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }

    .popup input, .popup select {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box; 
    }

    .popup .actions {
      display: flex;
      justify-content: space-between;
      margin-top: 1.5rem;
    }

    .popup .actions button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .popup .actions .save {
      background-color: #007bff;
      color: white;
    }
    .popup .actions .save:hover { background-color: #0056b3; }

    .popup .actions .delete {
      background-color: #dc3545;
      color: white;
    }
    .popup .actions .delete:hover { background-color: #c82333; }

    .popup .actions .cancel {
      background-color: #6c757d;
      color: white;
    }
    .popup .actions .cancel:hover { background-color: #5a6268; }

    .member-list {
        list-style: none;
        padding: 0;
        margin-top: 0.5rem;
        max-height: 100px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 4px;
    }

    .member-list li {
        padding: 0.3rem 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #f9f9f9;
    }
    .member-list li:last-child {
        border-bottom: none;
    }

    .member-list .remove-btn {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        font-size: 0.9rem;
        padding: 0 5px;
    }

    .add-user-section {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        align-items: flex-end;
    }

    .add-user-section select {
        flex-grow: 1;
        margin-top: 0;  
    }

    .add-user-section button {
        padding: 0.5rem 1rem;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
    }
    .add-user-section button:hover {
        background-color: #218838;
    }

    .report-section {
        margin-top: 2rem;
        padding: 1.5rem;
        background: #e9ecef;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        text-align: center;  
    }

    .report-section h3 {
        margin-top: 0;
        color: #343a40;
    }

    .report-button {
        background-color: #007bff;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.3s ease;
    }
    .report-button:hover {
        background-color: #2573c6;
    }


    #efficiencyReportPopup .popup {
        width: 600px; 
        max-width: 95%;
    }

    #efficiencyReportPopup h3 {
        text-align: center;
        margin-bottom: 1.5rem;
    }

    #efficiencyReportContent {
        margin-top: 1rem;
    }

    #efficiencyReportContent table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    #efficiencyReportContent th,
    #efficiencyReportContent td {
        padding: 0.75rem;
        border: 1px solid #ddd;
        text-align: left;
    }

    #efficiencyReportContent th {
        background-color: #f2f2f2;
        font-weight: bold;
    }

    .efficiency-rating-cell {
        font-weight: bold;
    }
    .efficiency-rating-cell.high {
        color: #28a745; 
    }

    .efficiency-rating-cell.medium {
        color: #ffc100; 
    }
    .efficiency-rating-cell.low {
        color: #dc3545; 
    }

    #reportPopupCloseBtn {
        background-color: #6c757d;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 1.5rem;
        display: block; 
        margin-left: auto;
        margin-right: auto;
        transition: background-color 0.3s ease;
    }
    #reportPopupCloseBtn:hover {
        background-color: #5a6268;
    }
  </style>
</head>

<body>
  <header>
    <h1> Manager Portal</h1>
    <a href="{% url 'logout' %}" class="logout-link">Logout</a>
  </header>

  <nav>
    <a href="{% url 'manager_teams_page' %}" class="active">Teams</a>
    <a href="{% url 'manager_demands_page' %}">Demands</a>
    <a href="{% url 'manager_approvals_page' %}">Approvals Pending</a>
  </nav>

  <div class="container">
    <div class="top-bar">
      <button id="addNewTeamBtn"> + Add New Team</button>
    </div>
    <div class="team-grid" id="teamsContainer">
      {# loading team data into the table #}
      <p id="loadingMessage">Loading teams...</p>
      <p id="noTeamsMessage" style="display:none;">No teams found. Click "Add New Team" to get started!</p>
    </div>

    <!-- Teams Efficiency Report Section  -->
    <div class="report-section">
        <h3>Teams Efficiency Report</h3>
        <button id="generateReportBtn" class="report-button">Generate Report</button>
    </div>
  </div>

  <!-- Popup for Add/Edit Team -->
  <div class="popup-bg" id="teamPopup">
    <div class="popup">
      <h3 id="popupTitle"></h3> 
      <input type="hidden" id="teamId" />

      <label for="teamName">Team Name:</label>
      <input type="text" id="teamName" />

      <label>Current Team Members:</label>
      <ul id="currentTeamMembersList" class="member-list">
        <li>No members yet.</li> 
      </ul>

      <div class="add-user-section">
        <select id="availableUsersSelect">
          <option value="">Select user to add</option>
        </select>
        <button id="addUserToTeamBtn">Add User</button>
      </div>

      <div class="actions">
        <button class="save" id="saveTeamBtn">Save</button>
        <button class="delete" id="deleteTeamBtn">Delete</button>
        <button class="cancel" id="cancelPopupBtn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Popup for Efficiency Report -->
  <div class="popup-bg" id="efficiencyReportPopup">
    <div class="popup">
        <h3>Teams Efficiency Report</h3>
        <div id="efficiencyReportContent">
            <p id="reportLoadingMessage" style="display:none; text-align: center;">Generating report...</p>
            <p id="reportErrorMessage" style="display:none; color: red; text-align: center;"></p>
            <p id="reportNoDataMessage" style="display:none; text-align: center;">No data to generate report. Ensure teams have completed demands.</p>
            <table id="efficiencyReportTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Team Name</th>
                        <th>Rating</th>
                        <th>Early</th>
                        <th>On-Time</th>
                        <th>Overdue</th>
                        <th>Total Completed</th>
                    </tr>
                </thead>
                <tbody id="efficiencyReportTableBody">
                </tbody>
            </table>
        </div>
        <button id="reportPopupCloseBtn">Close</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const teamPopup = document.getElementById('teamPopup'); 
      const overlay = document.getElementById('overlay'); 
      const popupTitle = document.getElementById('popupTitle');
      const teamIdInput = document.getElementById('teamId'); 
      const teamNameInput = document.getElementById('teamName'); 
      const currentTeamMembersList = document.getElementById('currentTeamMembersList');
      const availableUsersSelect = document.getElementById('availableUsersSelect');
      const addUserToTeamBtn = document.getElementById('addUserToTeamBtn');
      const saveTeamBtn = document.getElementById('saveTeamBtn');
      const deleteTeamBtn = document.getElementById('deleteTeamBtn');
      const cancelPopupBtn = document.getElementById('cancelPopupBtn');

      //references to the elements that trigger the popup
      const addNewTeamBtn = document.getElementById('addNewTeamBtn'); 
      const teamsListDiv = document.getElementById('teamsList');

      // Global state variables
      let currentEditTeamId = null;
      let currentTeamMembers = [];

      function showPopup(popupElement) {
        popupElement.style.display = 'flex'; 
        overlay.style.display = 'block';
      }

      function hidePopup() {
        teamPopup.style.display = 'none'; 
        overlay.style.display = 'none'; 

        currentEditTeamId = null;
        teamIdInput.value = '';
        teamNameInput.value = '';
        currentTeamMembersList.innerHTML = '<li>No members yet.</li>'; 
        currentTeamMembers = []; // Clear array
        availableUsersSelect.innerHTML = '<option value="">Select user to add</option>'; 
        deleteTeamBtn.style.display = 'inline-block'; 
    }
    // Fetches all teams and renders them on the main page
    async function fetchTeams() {
      loadingMessage.style.display = 'block';
      noTeamsMessage.style.display = 'none'; 
      teamsContainer.innerHTML = ''; 

      try {
        const response = await fetch('/api/manager/teams/'); 
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const teams = await response.json();

        loadingMessage.style.display = 'none'; 

        if (teams.length === 0) {
            noTeamsMessage.style.display = 'block'; 
            return;
        }

        teams.forEach(team => {
            const teamBox = document.createElement('div');
            teamBox.classList.add('team-box');
            teamBox.textContent = team.name; 
            teamBox.dataset.teamId = team.id; 
            
            teamBox.addEventListener('click', () => openTeamPopup(team.id));
            
            teamsContainer.appendChild(teamBox);
        });

      } catch (error) {
        console.error('Error fetching teams:', error);
        loadingMessage.textContent = 'Failed to load teams. Please try again later.'; // Display error message
        loadingMessage.style.color = 'red'; 
        noTeamsMessage.style.display = 'none'; 
      }
    }

    //dynamicallu populate team popup
    function renderTeamMembers(members) {
        currentTeamMembersList.innerHTML = '';

        if (!members || members.length === 0) {
            const li = document.createElement('li');
            li.textContent = 'No members yet.';
            li.classList.add('placeholder');
            currentTeamMembersList.appendChild(li);
            return;
        }

        members.forEach(member => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>${member.username}</span>
                <button class="remove-member-btn" data-member-id="${member.id}">Remove</button>
            `;
            li.querySelector('.remove-member-btn').addEventListener('click', function() {
                removeMemberFromTeam(member.id); 
            });
            currentTeamMembersList.appendChild(li);
        });
    }

    async function populateAvailableUsers(users) {
        availableUsersSelect.innerHTML = '<option value="">Select user to add</option>'; 
        const currentMemberIds = new Set(currentTeamMembers.map(m => m.id)); 

        users.forEach(user => {
            if (!currentMemberIds.has(user.id) && user.team==null) { 
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.username;
                availableUsersSelect.appendChild(option);
            }
        });
    }

    async function openTeamPopup(teamId = null) {
        console.log("openTeamPopup called for teamId:", teamId);

        currentEditTeamId = teamId;
        hidePopup(); 

        if (teamId) {
            popupTitle.textContent = 'Edit Team';
            deleteTeamBtn.style.display = 'inline-block'; 

            try {
                const team = await fetchData(`/api/manager/teams/${teamId}/`);
                if (team) {
                    teamIdInput.value = team.id;
                    teamNameInput.value = team.name;
                    currentTeamMembers = team.members || []; 
                    renderTeamMembers(currentTeamMembers); 
                } else {
                    alert('Team not found or an error occurred.');
                    hidePopup();
                    return;
                }
            } catch (error) {
                alert(`Failed to load team details: ${error.message}`);
                hidePopup();
                return;
            }
        } else { // Adding a new team
            popupTitle.textContent = 'Add New Team';
            deleteTeamBtn.style.display = 'none'; 
            teamIdInput.value = '';
            teamNameInput.value = '';
            currentTeamMembers = [];
            renderTeamMembers(currentTeamMembers);
        }

        try {
            const availableUsersResponse = await fetchData('/api/manager/users/available/');
            populateAvailableUsers(availableUsersResponse.users);
        } catch (error) {
            console.error('Failed to fetch available users:', error);
            alert(`Failed to load available users: ${error.message}`);
        }

        showPopup(teamPopup);
    }

    // Add user to team logic (within popup)
    addUserToTeamBtn.addEventListener('click', function() {
        const selectedUserId = availableUsersSelect.value;
        const selectedUserName = availableUsersSelect.options[availableUsersSelect.selectedIndex].text;

        if (selectedUserId && !currentTeamMembers.some(member => member.id == selectedUserId)) {
            const newUser = { id: parseInt(selectedUserId), username: selectedUserName };
            currentTeamMembers.push(newUser);
            renderTeamMembers(currentTeamMembers); // Update the displayed list
            
            // Remove the user from the available users dropdown
            availableUsersSelect.remove(availableUsersSelect.selectedIndex);
            availableUsersSelect.value = ""; // Reset dropdown
        } else {
            alert('Please select a user to add, or the user is already on the team.');
        }
    });

    // Remove user from team logic (within popup)
    function removeMemberFromTeam(memberIdToRemove) {
        currentTeamMembers = currentTeamMembers.filter(member => member.id !== memberIdToRemove);
        renderTeamMembers(currentTeamMembers); // Update the displayed list

        // Re-populate available users to potentially show the removed user again
        fetchData('/api/manager/unassigned_users/')
            .then(data => populateAvailableUsers(data.users))
            .catch(error => console.error("Error re-populating available users after removal:", error));
    }


    // Save team (new or update)
    saveTeamBtn.addEventListener('click', async function() {
        const teamName = teamNameInput.value.trim();
        if (!teamName) {
            alert('Team name cannot be empty.');
            return;
        }

        const memberIds = currentTeamMembers.map(member => member.id); // Get IDs of current members
        const teamData = {
            name: teamName,
            member_ids: memberIds
        };

        try {
            let response;
            if (currentEditTeamId) { // Update existing team
                response = await fetchData(`/api/manager/teams/${currentEditTeamId}/`, 'PUT', teamData);
                alert('Team updated successfully!');
            } else { // Create new team
                response = await fetchData('/api/manager/teams/', 'POST', teamData);
                alert('Team created successfully!');
            }
            console.log('Save response:', response);
            hidePopup(); // Close popup
            fetchTeams(); // Reload main page team list
        } catch (error) {
            alert(`Error saving team: ${error.message}`);
        }
    });

    // Delete team
    deleteTeamBtn.addEventListener('click', async function() {
        if (!currentEditTeamId || !confirm('Are you sure you want to delete this team? This action cannot be undone.')) {
            return; 
        }

        try {
            await fetchData(`/api/manager/teams/${currentEditTeamId}/`, 'DELETE');
            alert('Team deleted successfully!');
            hidePopup(); // Close popup
            fetchTeams(); // Reload main page team list
        } catch (error) {
            alert(`Error deleting team: ${error.message}`);
        }
    });

    // Cancel popup
    cancelPopupBtn.addEventListener('click', hidePopup);

    // --- 7. Initial Page Load (Fetch and display teams) ---
    fetchTeams();

    // --- 8. Event Listener for "Add New Team" button ---
    addNewTeamBtn.addEventListener('click', () => openTeamPopup(null)); // Pass null to indicate new team

    // fetches the efficiency report
    async function generateEfficiencyReport() {
        hidePopup(efficiencyReportPopup); 
        showPopup(efficiencyReportPopup); 
        reportLoadingMessage.style.display = 'block';
        reportErrorMessage.style.display = 'none';
        reportNoDataMessage.style.display = 'none';
        efficiencyReportTable.style.display = 'none';
        efficiencyReportTableBody.innerHTML = ''; 

        try {
            const response = await fetch('/api/manager/teams/efficiency-report/');
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to fetch efficiency report.');
            }
            const data = await response.json();
            const reportData = data.teams;  

            reportLoadingMessage.style.display = 'none';

            if (reportData.length === 0) {
                reportNoDataMessage.style.display = 'block';
            }

            efficiencyReportTable.style.display = 'table';  
            reportData.forEach(team => {
                const row = efficiencyReportTableBody.insertRow();
                
                const ratingClass = team.efficiency_rating >= 0.8 ? 'high' : 
                                    (team.efficiency_rating >= 0.5 ? 'medium' : 'low');

                row.innerHTML = `
                    <td>${team.team_name}</td>
                    <td class="efficiency-rating-cell ${ratingClass}">${(team.efficiency_rating * 100).toFixed(2)}%</td>
                    <td>${team.early_completions}</td>
                    <td>${team.on_time_completions}</td>
                    <td>${team.overdue_completions}</td>
                    <td>${team.total_completed_demands}</td>
                `;
            });

        } catch (error) {
            console.error('Error generating efficiency report:', error);
            reportLoadingMessage.style.display = 'none';
            reportErrorMessage.textContent = `Error: ${error.message}`;
            reportErrorMessage.style.display = 'block';
        }
    }
    });

    
    // csrf cookie handling
        function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

  </script>
</body>
</html>
